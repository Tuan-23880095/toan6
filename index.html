<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra Toán 6: Phân Số</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f9ff;
        }
        .hand-font {
            font-family: 'Patrick Hand', cursive;
        }
        /* Custom Fraction CSS */
        .fraction {
            display: inline-block;
            vertical-align: middle;
            margin: 0 0.2rem;
            text-align: center;
        }
        .fraction > span {
            display: block;
            padding: 0.1rem;
        }
        .fraction span.numerator {
            border-bottom: 2px solid currentColor;
        }
        .fraction span.denominator {
            display: block;
        }
        .math-symbol {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
        /* Animation for AI Comment */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBPRlkjpMLDctdm2Uk7aYex_P6Cx0uhIdUmwOcYEm9C7JDe5OH92FiWEn6Nz1HNenY-A/exec";

        // --- Data: Questions ---
        const quizData = [
            // Phần 1: Trắc nghiệm (4 câu) - 1 điểm mỗi câu (giả định)
            {
                id: 1,
                type: "multiple_choice",
                section: "I. Trắc nghiệm (4 câu)",
                question: "Trong các cách viết sau đây, cách viết nào KHÔNG phải là phân số?",
                options: [
                    { id: "A", label: "A", html: <div className="fraction"><span className="numerator">3</span><span className="denominator">2</span></div> },
                    { id: "B", label: "B", html: <div className="fraction"><span className="numerator">-8</span><span className="denominator">-9</span></div> },
                    { id: "C", label: "C", html: <div className="fraction"><span className="numerator">2,5</span><span className="denominator">-9,5</span></div> },
                    { id: "D", label: "D", html: <div className="fraction"><span className="numerator">0</span><span className="denominator">4</span></div> }
                ],
                correctAnswer: "C",
                explanation: "Phân số yêu cầu tử số và mẫu số phải là số nguyên. 2,5 và -9,5 là số thập phân."
            },
            {
                id: 2,
                type: "multiple_choice",
                section: "I. Trắc nghiệm (4 câu)",
                question: <span>Phân số <div className="fraction"><span className="numerator">-9</span><span className="denominator">7</span></div> được đọc là gì?</span>,
                options: [
                    { id: "A", text: "Chín phần bảy" },
                    { id: "B", text: "Âm bảy phần chín" },
                    { id: "C", text: "Bảy phần chín" },
                    { id: "D", text: "Âm chín phần bảy" }
                ],
                correctAnswer: "D",
                explanation: "Đọc tử số trước (Âm chín), rồi đến 'phần', rồi đến mẫu số (bảy)."
            },
            {
                id: 3,
                type: "multiple_choice",
                section: "I. Trắc nghiệm (4 câu)",
                question: <span>Phân số nào dưới đây bằng với phân số <div className="fraction"><span className="numerator">-2</span><span className="denominator">5</span></div>?</span>,
                options: [
                    { id: "A", html: <div className="fraction"><span className="numerator">4</span><span className="denominator">10</span></div> },
                    { id: "B", html: <div className="fraction"><span className="numerator">-6</span><span className="denominator">15</span></div> },
                    { id: "C", html: <div className="fraction"><span className="numerator">6</span><span className="denominator">15</span></div> },
                    { id: "D", html: <div className="fraction"><span className="numerator">-4</span><span className="denominator">100</span></div> }
                ],
                correctAnswer: "B",
                explanation: <span>Rút gọn <div className="fraction"><span className="numerator">-6</span><span className="denominator">15</span></div> (chia cả tử và mẫu cho 3) ta được <div className="fraction"><span className="numerator">-2</span><span className="denominator">5</span></div>.</span>
            },
            {
                id: 4,
                type: "multiple_choice",
                section: "I. Trắc nghiệm (4 câu)",
                question: "Lớp 6A có 45 học sinh, trong đó có 20 học sinh giỏi. Số học sinh giỏi chiếm bao nhiêu phần học sinh cả lớp?",
                options: [
                    { id: "A", html: <div className="fraction"><span className="numerator">1</span><span className="denominator">9</span></div> },
                    { id: "B", html: <div className="fraction"><span className="numerator">4</span><span className="denominator">9</span></div> },
                    { id: "C", html: <div className="fraction"><span className="numerator">1</span><span className="denominator">3</span></div> },
                    { id: "D", html: <div className="fraction"><span className="numerator">3</span><span className="denominator">5</span></div> }
                ],
                correctAnswer: "B",
                explanation: <span>Lập phân số <div className="fraction"><span className="numerator">20</span><span className="denominator">45</span></div>, rút gọn cho 5 được <div className="fraction"><span className="numerator">4</span><span className="denominator">9</span></div>.</span>
            },
            // Phần 2: Đúng Sai (4 câu)
            {
                id: 5,
                type: "true_false",
                section: "II. Đúng / Sai (4 câu)",
                question: "Phân số nhỏ hơn số 0 gọi là phân số âm.",
                options: [
                    { id: "True", text: "Đúng" },
                    { id: "False", text: "Sai" }
                ],
                correctAnswer: "True",
                explanation: "Theo định nghĩa SGK, phân số nhỏ hơn 0 là phân số âm."
            },
            {
                id: 6,
                type: "true_false",
                section: "II. Đúng / Sai (4 câu)",
                question: <span>Mọi số nguyên <span className="math-symbol">a</span> đều có thể viết dưới dạng phân số là <div className="fraction"><span className="numerator">a</span><span className="denominator">0</span></div>.</span>,
                options: [
                    { id: "True", text: "Đúng" },
                    { id: "False", text: "Sai" }
                ],
                correctAnswer: "False",
                explanation: <span>Mẫu số phải khác 0. Cách viết đúng là <div className="fraction"><span className="numerator">a</span><span className="denominator">1</span></div>.</span>
            },
            {
                id: 7,
                type: "true_false",
                section: "II. Đúng / Sai (4 câu)",
                question: <span>Phân số <div className="fraction"><span className="numerator">-2</span><span className="denominator">-5</span></div> là phân số dương.</span>,
                options: [
                    { id: "True", text: "Đúng" },
                    { id: "False", text: "Sai" }
                ],
                correctAnswer: "True",
                explanation: "Tử và mẫu cùng dấu (cùng âm) nên phân số có giá trị dương."
            },
            {
                id: 8,
                type: "true_false",
                section: "II. Đúng / Sai (4 câu)",
                question: "Số 0 KHÔNG thể viết được dưới dạng phân số.",
                options: [
                    { id: "True", text: "Đúng" },
                    { id: "False", text: "Sai" }
                ],
                correctAnswer: "False",
                explanation: <span>Sai. Số 0 có thể viết là <div className="fraction"><span className="numerator">0</span><span className="denominator">a</span></div> (với a khác 0).</span>
            },
            // Phần 3: Điền khuyết / Trả lời nhanh (2 câu)
            {
                id: 9,
                type: "fill_in",
                section: "III. Trả lời nhanh (2 câu)",
                question: <span>Tìm số nguyên <span className="math-symbol">x</span>, biết: <div className="fraction"><span className="numerator">35</span><span className="denominator">15</span></div> = <div className="fraction"><span className="numerator">x</span><span className="denominator">3</span></div></span>,
                options: [
                    { id: "A", text: "x = 5" },
                    { id: "B", text: "x = 7" },
                    { id: "C", text: "x = 15" },
                    { id: "D", text: "x = 6" }
                ],
                correctAnswer: "B",
                explanation: <span>Rút gọn <div className="fraction"><span className="numerator">35</span><span className="denominator">15</span></div> = <div className="fraction"><span className="numerator">7</span><span className="denominator">3</span></div>. Suy ra x = 7.</span>
            },
            {
                id: 10,
                type: "fill_in",
                section: "III. Trả lời nhanh (2 câu)",
                question: <span>Viết 20 dm² dưới dạng phân số với đơn vị là m².</span>,
                hint: "(Gợi ý: 1 m² = 100 dm²)",
                options: [
                    { id: "A", html: <span><div className="fraction"><span className="numerator">20</span><span className="denominator">10</span></div> m²</span> },
                    { id: "B", html: <span><div className="fraction"><span className="numerator">100</span><span className="denominator">20</span></div> m²</span> },
                    { id: "C", html: <span><div className="fraction"><span className="numerator">20</span><span className="denominator">100</span></div> m²</span> },
                    { id: "D", html: <span><div className="fraction"><span className="numerator">20</span><span className="denominator">1000</span></div> m²</span> }
                ],
                correctAnswer: "C",
                explanation: <span>Vì 1 dm² = <div className="fraction"><span className="numerator">1</span><span className="denominator">100</span></div> m², nên 20 dm² = <div className="fraction"><span className="numerator">20</span><span className="denominator">100</span></div> m².</span>
            }
        ];

        // --- Components ---

        // FIX: Component Icon mới sử dụng useRef để tránh xung đột DOM giữa React và Lucide
        const Icon = ({ name, className }) => {
            const ref = React.useRef(null);

            React.useEffect(() => {
                if (typeof lucide !== 'undefined' && ref.current) {
                    // Tạo element tạm cho Lucide xử lý
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) {
                        i.className = className;
                    }
                    
                    // Xóa nội dung cũ và thêm element mới vào container
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    
                    // Gọi Lucide render trong phạm vi container (ref)
                    lucide.createIcons({
                        root: ref.current
                    });
                }
            }, [name, className]);

            // React chỉ quản lý thẻ span này, nội dung bên trong do Lucide quản lý thủ công
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const StartScreen = ({ onStart }) => {
            const [studentName, setStudentName] = useState("");
            const [className, setClassName] = useState("");

            const handleSubmit = () => {
                if (studentName.trim() && className.trim()) {
                    onStart(studentName, className);
                } else {
                    alert("Vui lòng nhập đầy đủ Họ tên và Lớp!");
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[70vh] text-center p-6 bg-white rounded-2xl shadow-xl max-w-2xl mx-auto mt-10">
                    <div className="bg-blue-100 p-6 rounded-full mb-6">
                        <Icon name="book-open" className="text-blue-600 w-16 h-16" />
                    </div>
                    <h1 className="text-4xl font-bold text-gray-800 mb-4 hand-font">Kiểm Tra Toán 6</h1>
                    <h2 className="text-2xl text-blue-600 mb-6 font-semibold">Chủ đề: Phân Số</h2>
                    
                    <div className="w-full max-w-md space-y-4 mb-8 text-left">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Họ và tên học sinh</label>
                            <input 
                                type="text" 
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                placeholder="Nhập họ tên của bạn..."
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Lớp</label>
                            <input 
                                type="text" 
                                value={className}
                                onChange={(e) => setClassName(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                placeholder="Ví dụ: 6A1"
                            />
                        </div>
                    </div>

                    <div className="text-left bg-gray-50 p-6 rounded-lg w-full max-w-md mb-8 border border-gray-200 text-sm">
                        <p className="mb-2 flex items-center gap-2"><Icon name="check-circle" className="w-4 h-4 text-green-500"/> <strong>4 Câu Trắc Nghiệm</strong></p>
                        <p className="mb-2 flex items-center gap-2"><Icon name="check-circle" className="w-4 h-4 text-green-500"/> <strong>4 Câu Đúng/Sai</strong></p>
                        <p className="mb-0 flex items-center gap-2"><Icon name="check-circle" className="w-4 h-4 text-green-500"/> <strong>2 Câu Trả Lời Nhanh</strong></p>
                    </div>

                    <button 
                        onClick={handleSubmit}
                        className="group relative px-8 py-4 bg-blue-600 text-white font-bold rounded-full text-xl shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 active:scale-95 flex items-center gap-3"
                    >
                        Bắt đầu làm bài
                        <Icon name="arrow-right" className="w-6 h-6 group-hover:translate-x-1 transition-transform" />
                    </button>
                </div>
            );
        };

        const ResultScreen = ({ answers, aiComment, onRetry }) => {
            const score = quizData.reduce((acc, q) => {
                return acc + (answers[q.id] === q.correctAnswer ? 1 : 0);
            }, 0);
            const total = quizData.length;
            const percentage = Math.round((score / total) * 100);

            let message = "";
            let colorClass = "";
            if (percentage >= 90) { message = "Xuất sắc!"; colorClass = "text-green-600"; }
            else if (percentage >= 70) { message = "Làm tốt lắm!"; colorClass = "text-blue-600"; }
            else if (percentage >= 50) { message = "Đạt yêu cầu"; colorClass = "text-yellow-600"; }
            else { message = "Cần cố gắng hơn nhé!"; colorClass = "text-red-600"; }

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden mt-6 mb-10">
                    <div className="bg-slate-800 text-white p-8 text-center">
                        <h2 className="text-3xl font-bold mb-2">Kết Quả Bài Làm</h2>
                        <div className="text-5xl font-black mb-2">{score}/{total}</div>
                        <p className={`text-2xl font-bold hand-font ${percentage >= 50 ? 'text-green-300' : 'text-red-300'}`}>{message}</p>
                    </div>

                    {/* AI Comment Section */}
                    <div className="p-6 bg-indigo-50 border-b border-indigo-100">
                        <div className="flex items-start gap-4">
                            <div className="bg-indigo-600 p-2 rounded-full shadow-lg shrink-0">
                                <Icon name="bot" className="w-8 h-8 text-white" />
                            </div>
                            <div className="flex-grow animate-fade-in">
                                <h3 className="text-lg font-bold text-indigo-900 mb-1">Nhận xét từ Trợ lý AI</h3>
                                <div className="bg-white p-4 rounded-lg rounded-tl-none shadow-sm border border-indigo-100 text-gray-700 italic">
                                    "{aiComment || "Đang phân tích kết quả..."}"
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6 bg-gray-50">
                        {quizData.map((q, index) => {
                            const isCorrect = answers[q.id] === q.correctAnswer;
                            const userAnswer = answers[q.id];
                            
                            const getOptionLabel = (optId) => {
                                const opt = q.options.find(o => o.id === optId);
                                if (!opt) return "Chưa chọn";
                                return opt.html || opt.text || opt.label;
                            };

                            return (
                                <div key={q.id} className={`border-l-4 p-4 bg-white shadow-sm rounded-r-lg ${isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-gray-800 text-lg">Câu {index + 1}: <span className="font-normal text-base">{q.question}</span></h3>
                                        {isCorrect ? 
                                            <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1"><Icon name="check" className="w-4 h-4"/> Đúng</span> : 
                                            <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1"><Icon name="x" className="w-4 h-4"/> Sai</span>
                                        }
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 text-sm">
                                        <div className={`${isCorrect ? 'text-green-700' : 'text-red-600'}`}>
                                            <span className="font-bold">Bạn chọn:</span> <div className="inline-block">{getOptionLabel(userAnswer)}</div>
                                        </div>
                                        {!isCorrect && (
                                            <div className="text-green-700">
                                                <span className="font-bold">Đáp án đúng:</span> <div className="inline-block">{getOptionLabel(q.correctAnswer)}</div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="mt-3 bg-blue-50 p-3 rounded text-blue-800 text-sm">
                                        <strong>Giải thích: </strong> {q.explanation}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="p-8 text-center bg-white border-t">
                        <button 
                            onClick={onRetry}
                            className="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition flex items-center gap-2 mx-auto"
                        >
                            <Icon name="rotate-ccw" className="w-5 h-5" /> Làm bài mới
                        </button>
                    </div>
                </div>
            );
        };

        const QuizScreen = ({ onFinish }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(15 * 60);

            useEffect(() => {
                const timer = setInterval(() => {
                    setTimeLeft((prev) => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            onFinish(answers);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [answers, onFinish]);

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const handleAnswer = (optionId) => {
                setAnswers({ ...answers, [quizData[currentQuestionIndex].id]: optionId });
            };

            const handleNext = () => {
                if (currentQuestionIndex < quizData.length - 1) {
                    setCurrentQuestionIndex(prev => prev + 1);
                } else {
                    onFinish(answers);
                }
            };

            const handlePrev = () => {
                if (currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(prev => prev - 1);
                }
            };

            const currentQ = quizData[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === quizData.length - 1;
            const progress = ((currentQuestionIndex + 1) / quizData.length) * 100;

            return (
                <div className="max-w-3xl mx-auto mt-6 p-4">
                    {/* Header Info */}
                    <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
                        <div>
                            <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">Câu hỏi</span>
                            <div className="text-2xl font-bold text-blue-600">{currentQuestionIndex + 1}<span className="text-gray-400 text-lg">/{quizData.length}</span></div>
                        </div>
                        <div className="text-center hidden sm:block">
                            <h2 className="text-sm font-semibold text-gray-600 bg-gray-100 px-3 py-1 rounded-full">{currentQ.section}</h2>
                        </div>
                        <div className="flex items-center gap-2 text-orange-600 font-bold bg-orange-50 px-4 py-2 rounded-lg border border-orange-100">
                            <Icon name="clock" className="w-5 h-5" />
                            {formatTime(timeLeft)}
                        </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                        <div className="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${progress}%` }}></div>
                    </div>

                    {/* Question Card */}
                    <div className="bg-white rounded-2xl shadow-lg p-6 md:p-10 min-h-[400px] flex flex-col relative">
                        <div className="flex-grow">
                            <h3 className="text-xl md:text-2xl font-medium text-gray-800 mb-2 leading-relaxed">
                                {currentQ.question}
                            </h3>
                            {currentQ.hint && <p className="text-sm text-gray-500 italic mb-6">{currentQ.hint}</p>}
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                {currentQ.options.map((opt) => {
                                    const isSelected = answers[currentQ.id] === opt.id;
                                    return (
                                        <button
                                            key={opt.id}
                                            onClick={() => handleAnswer(opt.id)}
                                            className={`p-4 rounded-xl border-2 text-left transition-all flex items-center gap-3 relative
                                                ${isSelected 
                                                    ? 'border-blue-500 bg-blue-50 shadow-md ring-2 ring-blue-200 ring-opacity-50' 
                                                    : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'
                                                }`}
                                        >
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center border font-bold shrink-0
                                                ${isSelected ? 'bg-blue-500 text-white border-blue-500' : 'text-gray-500 border-gray-300 bg-white'}
                                            `}>
                                                {opt.id}
                                            </div>
                                            <div className="text-lg text-gray-700">
                                                {opt.html || opt.text || opt.label}
                                            </div>
                                            {isSelected && <Icon name="check-circle" className="absolute right-4 text-blue-500 w-5 h-5" />}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="flex justify-between mt-8 pt-6 border-t border-gray-100">
                            <button 
                                onClick={handlePrev}
                                disabled={currentQuestionIndex === 0}
                                className={`flex items-center gap-2 px-5 py-2 rounded-lg font-medium transition
                                    ${currentQuestionIndex === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-100'}`}
                            >
                                <Icon name="arrow-left" className="w-5 h-5" /> Quay lại
                            </button>
                            
                            <button 
                                onClick={handleNext}
                                className={`flex items-center gap-2 px-8 py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95
                                    ${isLastQuestion 
                                        ? 'bg-green-600 text-white hover:bg-green-700' 
                                        : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                            >
                                {isLastQuestion ? 'Nộp bài' : 'Câu tiếp theo'}
                                {!isLastQuestion && <Icon name="arrow-right" className="w-5 h-5" />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-8 rounded-xl shadow-2xl text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mx-auto mb-4"></div>
                    <h2 className="text-xl font-bold text-gray-800">Đang chấm điểm...</h2>
                    <p className="text-gray-600 mt-2">Hệ thống AI đang phân tích bài làm của bạn</p>
                </div>
            </div>
        );

        const App = () => {
            const [gameState, setGameState] = useState('intro'); // intro, quiz, submitting, result
            const [userInfo, setUserInfo] = useState({ name: '', class: '' });
            const [userAnswers, setUserAnswers] = useState({});
            const [aiComment, setAiComment] = useState("");

            const startQuiz = (name, className) => {
                setUserInfo({ name, class: className });
                setGameState('quiz');
            };
            
            const submitData = async (answers) => {
                setGameState('submitting');
                setUserAnswers(answers);

                // 1. Calculate Local Scores
                let p1 = 0, p2 = 0, p3 = 0;
                let answerLog = [];
                let headersLog = [];

                quizData.forEach(q => {
                    const isCorrect = answers[q.id] === q.correctAnswer;
                    if (q.type === "multiple_choice") {
                        if (isCorrect) p1 += 1;
                        headersLog.push(`Câu ${q.id} (TN)`);
                    } else if (q.type === "true_false") {
                        if (isCorrect) p2 += 1;
                        headersLog.push(`Câu ${q.id} (Đ/S)`);
                    } else {
                        if (isCorrect) p3 += 1;
                        headersLog.push(`Câu ${q.id} (Điền)`);
                    }
                    answerLog.push(answers[q.id] || "Bỏ qua");
                });

                const totalScore = p1 + p2 + p3;
                const maxScore = quizData.length;

                // 2. Get AI Comment
                let comment = "";
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: "get_comment",
                            score: totalScore,
                            maxScore: maxScore,
                            p1: p1, p2: p2, p3: p3, p4: 0 // Không có tự luận
                        })
                    });
                    const data = await response.json();
                    comment = data.comment || "Đã có lỗi khi lấy nhận xét.";
                } catch (e) {
                    console.error("Error getting comment:", e);
                    comment = "Không thể kết nối với AI Server.";
                }
                setAiComment(comment);

                // 3. Save to Sheet
                const summaryHeaders = ["Tổng Điểm", "TN", "Đ/S", "Điền"];
                const summaryScores = [`${totalScore}/${maxScore}`, p1, p2, p3];
                
                const payload = {
                    action: "save_score",
                    role: "Kiểm tra Toán 6: Phân Số",
                    evaluator: userInfo.name,
                    groupName: userInfo.class,
                    comment: comment,
                    headers: summaryHeaders.concat(headersLog),
                    scores: summaryScores.concat(answerLog)
                };

                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.error("Error saving score:", e);
                }

                setGameState('result');
            };

            const retryQuiz = () => {
                setUserAnswers({});
                setGameState('intro');
                setAiComment("");
            };

            return (
                <div className="min-h-screen pb-10">
                    {/* Top Bar Decoration */}
                    <div className="h-2 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                    
                    {gameState === 'intro' && <StartScreen onStart={startQuiz} />}
                    {gameState === 'quiz' && <QuizScreen onFinish={submitData} />}
                    {gameState === 'submitting' && <LoadingScreen />}
                    {gameState === 'result' && <ResultScreen answers={userAnswers} aiComment={aiComment} onRetry={retryQuiz} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
